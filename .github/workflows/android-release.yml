name: Android Build and Release

on:
  push:
    branches:
      - main
    tags:
      - 'v*'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
      ANDROID_HOME: /usr/local/lib/android/sdk

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Ensure sdkmanager, install cmdline-tools and required NDK, accept licenses
        run: |
          set -euo pipefail
          SDK_ROOT="${ANDROID_SDK_ROOT:-/usr/local/lib/android/sdk}"
          echo "Using ANDROID_SDK_ROOT=$SDK_ROOT"
          export ANDROID_SDK_ROOT="$SDK_ROOT"
          export ANDROID_HOME="$SDK_ROOT"

          # Try to find sdkmanager in common locations or on PATH
          if [ -x "$SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" ]; then
            SDKMANAGER="$SDK_ROOT/cmdline-tools/latest/bin/sdkmanager"
          elif [ -x "$SDK_ROOT/cmdline-tools/bin/sdkmanager" ]; then
            SDKMANAGER="$SDK_ROOT/cmdline-tools/bin/sdkmanager"
          elif [ -x "$SDK_ROOT/tools/bin/sdkmanager" ]; then
            SDKMANAGER="$SDK_ROOT/tools/bin/sdkmanager"
          elif command -v sdkmanager >/dev/null 2>&1; then
            SDKMANAGER="$(command -v sdkmanager)"
          else
            # Try bootstrapping cmdline-tools by using the bundled sdkmanager if present in runner
            echo "sdkmanager not found in SDK, attempting to install cmdline-tools via apt-get fallback (if available)"
            # On ubuntu-latest, sdkmanager is usually present. If not, fail with clear message.
            echo "ERROR: sdkmanager not found. Ensure Android SDK cmdline-tools are available on the runner." >&2
            exit 1
          fi

          echo "Using sdkmanager at: $SDKMANAGER"

          # Ensure cmdline-tools;latest exists (if using sdkmanager that's part of an older tools package this will be a no-op)
          # Install cmdline-tools;latest if sdkmanager is capable (some runners already have it)
          YES_YN="y"
          printf '%s\n' "$YES_YN" | "$SDKMANAGER" --sdk_root="$SDK_ROOT" --install "cmdline-tools;latest" || true

          # Install the exact NDK required by the project
          printf '%s\n' "$YES_YN" | "$SDKMANAGER" --sdk_root="$SDK_ROOT" --install "ndk;28.0.12433566" || true

          # Accept all licenses
          printf '%s\n' "$YES_YN" | "$SDKMANAGER" --sdk_root="$SDK_ROOT" --licenses

      # Создаём google-services.json только если секрет задан (Firebase временно отключён)
      - name: Create google-services.json
        if: ${{ secrets.GOOGLE_SERVICES_JSON != '' }}
        run: |
          mkdir -p app
          echo '${{ secrets.GOOGLE_SERVICES_JSON }}' > app/google-services.json

      - name: Build Release APK
        run: ./gradlew assembleRelease --no-daemon
        env:
          JAVA_TOOL_OPTIONS: "-Dfile.encoding=UTF8"

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-release
          path: app/build/outputs/apk/release/*.apk

      - name: Create Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: app/build/outputs/apk/release/*.apk
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
