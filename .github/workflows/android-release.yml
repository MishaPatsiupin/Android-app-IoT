name: Android Build and Release

on:
  push:
    branches:
      - main
    tags:
      - 'v*'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
      ANDROID_HOME: /usr/local/lib/android/sdk

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Ensure sdkmanager, install cmdline-tools and required NDK, accept licenses
        run: |
          set -euo pipefail
          SDK_ROOT="${ANDROID_SDK_ROOT:-/usr/local/lib/android/sdk}"
          echo "Using ANDROID_SDK_ROOT=$SDK_ROOT"
          export ANDROID_SDK_ROOT="$SDK_ROOT"
          export ANDROID_HOME="$SDK_ROOT"

          # Find sdkmanager
          if [ -x "$SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" ]; then
            SDKMANAGER="$SDK_ROOT/cmdline-tools/latest/bin/sdkmanager"
          elif [ -x "$SDK_ROOT/cmdline-tools/bin/sdkmanager" ]; then
            SDKMANAGER="$SDK_ROOT/cmdline-tools/bin/sdkmanager"
          elif [ -x "$SDK_ROOT/tools/bin/sdkmanager" ]; then
            SDKMANAGER="$SDK_ROOT/tools/bin/sdkmanager"
          elif command -v sdkmanager >/dev/null 2>&1; then
            SDKMANAGER="$(command -v sdkmanager)"
          else
            echo "ERROR: sdkmanager not found. Ensure Android SDK cmdline-tools are available on the runner." >&2
            exit 1
          fi

          echo "Using sdkmanager at: $SDKMANAGER"

          # Install cmdline-tools (if missing), required NDK and accept licenses
          printf 'y\n' | "$SDKMANAGER" --sdk_root="$SDK_ROOT" --install "cmdline-tools;latest" || true
          printf 'y\n' | "$SDKMANAGER" --sdk_root="$SDK_ROOT" --install "ndk;27.2.12479018" || true
          printf 'y\n' | "$SDKMANAGER" --sdk_root="$SDK_ROOT" --licenses

      - name: Create google-services.json (only if secret present)
        run: |
          mkdir -p app
          if [ -n "${{ secrets.GOOGLE_SERVICES_JSON }}" ]; then
            printf '%s' "${{ secrets.GOOGLE_SERVICES_JSON }}" > app/google-services.json
            echo "google-services.json created"
          else
            echo "GOOGLE_SERVICES_JSON secret not set â€” skipping creation"
          fi

      - name: Build Release APK
        run: ./gradlew assembleRelease --no-daemon
        env:
          JAVA_TOOL_OPTIONS: "-Dfile.encoding=UTF8"

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-release
          path: app/build/outputs/apk/release/*.apk

      - name: Create Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: app/build/outputs/apk/release/*.apk
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
